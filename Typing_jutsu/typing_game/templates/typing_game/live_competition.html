<!-- live_competition.html - Major updates needed -->
{% extends 'typing_game/base.html' %}
{% load static %}

{% block title %}Live Competition: {{ competition.title }}{% endblock %}

{% block page %}
<style>
    /* Add these styles to your existing CSS */
    .countdown-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    
    .countdown-box {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        text-align: center;
    }
    
    .countdown-number {
        font-size: 5rem;
        font-weight: bold;
        color: var(--accent-color);
    }
    
    .competition-status {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        text-align: center;
        font-weight: bold;
    }
    
    .status-waiting {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .status-active {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-ended {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .text-display {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .repeat-indicator {
        background-color: #e9ecef;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.9rem;
        margin-top: 10px;
        display: inline-block;
    }
</style>

<div class="competition-container">
    <h1>{{ competition.title }}</h1>
    
    <div class="competition-status" id="competition-status">
        {% if competition.status == 'waiting' %}
            <div class="status-waiting">Waiting to start... Participants can join</div>
        {% elif competition.status == 'active' %}
            <div class="status-active">Competition in progress</div>
        {% elif competition.status == 'ended' %}
            <div class="status-ended">Competition ended</div>
        {% endif %}
    </div>
    
    <div class="timer-container">
        Time Remaining: <span id="timer">00:00:00</span>
    </div>
    
    {% if user_role == 'participant' %}
        <!-- Participant View -->
        <div class="typing-container" id="typing-container">
            {% if competition.status == 'waiting' %}
                <div class="finished-message">
                    <p>The competition will start soon. Please wait...</p>
                </div>
            {% elif competition.status == 'active' %}
                <div class="text-display" id="text-display">
                    {% if competition.type == 'Jumble-Word' %}
                        <div class="jumble-container">
                            <h3>Unscramble these words:</h3>
                            {% for item in competition.paragraphs %}
                                <span class="jumble-word" data-answer="{{ item.answer }}">{{ item.jumbled }}</span>
                            {% endfor %}
                        </div>
                    {% else %}
                        {% for item in competition.paragraphs %}
                            <p id="thePara">{{ item.text }}</p>
                        {% endfor %}
                    {% endif %}
                </div>
                
                <textarea id="typing-input" class="input-area" placeholder="Start typing here..." 
                          {% if competition.type == 'Reverse' %}data-reverse="true"{% endif %}></textarea>
                
                <div class="stats-container">
                    <div class="stat-box">
                        <div class="stat-value" id="wpm">0</div>
                        <div class="stat-label">WPM</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="accuracy">100%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="time">0s</div>
                        <div class="stat-label">Time</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="repeats">0</div>
                        <div class="stat-label">Repeats</div>
                    </div>
                </div>
                
                <div class="controls">
                    <button id="reset-btn" class="btn btn-secondary">Reset</button>
                    <button id="submit-btn" class="btn btn-primary">Submit</button>
                </div>
            {% elif competition.status == 'ended' %}
                <div class="finished-message">
                    <p>The competition has ended. Thank you for participating!</p>
                    <p>Your final results have been submitted.</p>
                </div>
            {% endif %}
        </div>
    {% else %}
        <!-- Organizer View -->
        <div class="leaderboard">
            <h2>Live Leaderboard</h2>
            
            {% if results %}
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th class="rank">Rank</th>
                            <th class="participant-name">Participant</th>
                            <th>WPM</th>
                            <th>Accuracy</th>
                            <th class="score">Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in results %}
                            <tr>
                                <td class="rank">{{ forloop.counter }}</td>
                                <td class="participant-name">{{ result.participant.name }}</td>
                                <td>{{ result.wpm|floatformat:1 }}</td>
                                <td>{{ result.accuracy|floatformat:1 }}%</td>
                                <td class="score">{{ result.score|floatformat:2 }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="finished-message">No submissions yet. Waiting for participants to submit their results.</p>
            {% endif %}
        </div>
        
        {% if competition.status == 'waiting' %}
            <div class="controls" style="margin-top: 20px;">
                <button id="start-now-btn" class="btn btn-primary">Start Competition Now</button>
            </div>
        {% endif %}
    {% endif %}
</div>

<!-- Countdown overlay -->
<div id="countdown-overlay" class="countdown-overlay" style="display: none;">
    <div class="countdown-box">
        <div class="countdown-number" id="countdown-number">3</div>
        <p>Competition starting in...</p>
    </div>
</div>

<script>
    // Store competition data
    const competitionData = {
        id: "{{ competition.id }}",
        type: "{{ competition.type }}",
        status: "{{ competition.status }}",
        duration: parseInt("{{ competition.duration }}") * 60, // Convert to seconds
        timeRemaining: parseInt("{{ time_remaining_seconds }}"),
        startTime: "{{ competition.start_time|date:'c' }}",
        endTime: "{{ competition.end_time|date:'c' }}",
        submitUrl: "{% url 'typing_game:submit_result' competition.id %}",
        startNowUrl: "{% url 'typing_game:start_competition_now' competition.id %}",
        updateStatusUrl: "{% url 'typing_game:update_competition_status' competition.id %}"
    };
    
    const csrfToken = "{{ csrf_token }}";
    const userRole = "{{ user_role }}";
</script>

<script src="{% static 'typing_game/js/live_competition.js' %}"></script>
{% endblock %}