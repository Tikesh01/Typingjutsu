<!-- live_competition.html -->
{% extends 'typing_game/base.html' %} 
{% load static %} 

{% block title %}Live Competition: {{ competition.title }}{% endblock %}

{% block page %}
<style>
    .page-header{
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap; /* Allows items to wrap on smaller screens */
        gap: 1em;
    }
    .page-header h1 {
        margin: 0.8em 0;
    }
    .correct-word {
        color: #a5d6a7; /* Light green */
    }
    .incorrect-word {
        background-color: #ef9a9a40; /* Light red background */
    }
    .race-track-container {
        margin: 0.2em 0;
        padding: 1em 1.5em;
        background-color: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
    }
    .race-track {
        position: relative;
        width: 100%;
        height: 40px;
        background: linear-gradient(to right, #374151, #4b5563);
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 1em;
        font-size: 1.5em;
    }
    #racer-icon {
        position: absolute;
        left: 0%; /* Start at 0% */
        transform: translateX(-50%);
        transition: left 0.3s linear;
        font-size: 1.2em;
    }
       
    .performance{
        margin-bottom: 1em;
        background-color: rgba(0, 0, 0, 0.227);
        padding: 1em 6em;
        display: flex;
        justify-content: space-between;
        .stat-box{
            display: flex;
            gap: 1em;
            text-align: center;
            h4{
                margin-bottom: 0.5em;
                color: orange;
            }
        }
    }
    #text-display{
        border: 0.5px gainsboro solid;
        border-radius: 10px;
        padding: 0.8em 2em;
        text-align: justify;
        word-spacing: 0.4em;
        letter-spacing: 0.2em;
        line-height: 1.85;
        color: darkgrey;
        max-height: 15em;
        overflow: auto;
    }
    #para-header{
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .half-header{
        display: flex;
        gap: 2em;
    }
    #duration{
       color: orange;
    }
    .type-para{
        padding: 1em;
        display: flex;
        flex-direction: column;
        gap: 0.5em;
        textarea{
            width: 100%;
            background: transparent;
            color: azure;
            border: 1px solid rgb(12, 127, 215);
            padding: 1em 2em;
            border-radius: 20px;
            font-size: larger;
        }
        textarea:focus {
            outline: none;
            border-color: orange;
            box-shadow: 0 0 5px orange;
        }
        textarea:disabled {
            background-color: #333;
            cursor: not-allowed;
        }
    }
    .participant-list {
        list-style-type: none;
        padding: 0;
    }
    .participant-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1em;
        margin-top: 1em;
    }
    .participant-list li {
        background-color: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 0.6em 1em;
        display: flex;
        align-items: center;
        gap: 0.8em;
        font-size: 1.1em;
        counter-increment: participant-counter;
    }
    .participant-list li::before {
        content: counter(participant-counter);
        background-color: #007bff;
        color: white;
        border-radius: 50%;
        width: 2em;
        height: 2em;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    .description_container{
        margin: 1em 0;
    }
    #countdown-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: none; /* Hidden by default */
        justify-content: center;
        align-items: center;
        z-index: 1002;
        flex-direction: column;
        color: white;
    }
    #countdown-number {
        font-size: 8em;
        font-weight: bold;
        color: orange;
    }
    #countdown-message {
        font-size: 1.5em;
        margin-top: 1em;
    }
</style>
<div class="page-header">
    <h1>{{competition.title}} is live</h1>
    <div class="half-header">
        {% if competition.organizer.id == user_id and user_role == 'organizer' %}
            <a href="{% url 'typing_game:deactivate_competition' competition.id %}" class="button" onclick="return confirm('Are you sure you want to deactivate this competition?')">Deactivate</a>
            {%if competition.started %}
                <a href="#" class="button danger" onclick="return confirm('Are you sure you want to restart the competition?')" >Restart Competition</a>
            {% else %}
                 <a href="{% url 'typing_game:start_competition' competition.id %}" class="button primary" onclick="return confirm('Are you sure you want to start the competition?')">Start Competition</a>
            {%endif%}
        {%endif%}
        <span id="expand-btn" class="button" onclick="toggleExpand('container')"><i class="fas fa-expand"></i></span>
    </div>
</div>

{% if competition.organizer.id == user_id and user_role == 'organizer' %}
    <div class="container">
        <h2 class="section-header">Joined Participants ({{ joined_participants.count }})</h2>
        <ul class="participant-list">
            {% for participant in joined_participants %}
                <li><strong>{{ participant.name }}</strong></li>
            {% empty %}
                <li>No participants have joined yet.</li>
            {% endfor %}
        </ul>
    </div>
{%else%}
    <div class="container">
        <h2 class="section-header">Your Performance</h2> 
        <div class="performance">
            <div class="stat-box">
                <h4>WPM:</h4>
                <p id="wpm">0</p>
            </div>
            <div class="stat-box">
                <h4>Accuracy:</h4>
                <p id="accuracy">100%</p>
            </div>
            <div class="stat-box">
                <h4>Time:</h4>
                <p id="time">0s/{{competition.duration}} minute(s)</p>
            </div>
        </div>
        <div class="race-track-container">
            <div class="race-track">
                <span>üèÅ</span>
                <div id="racer-icon">üèéÔ∏è</div>
                <span>üèÜ</span>
            </div>
        </div>

        <div id="para-header">
            <h2>Uploaded Paragraph </h2> 
            <div class="half-header">
                <span id="duration">{{competition.duration}} minute(s)</span> 
                <span>{{competition.type}} typing</span>
                {% if competition.started %}
                    <span>{{competition.start_time}} - {{competition.end_time}}</span>
                {%endif%}
            </div>
        </div>
        <div id="text-display" >
            {% for para in competition.paragraphs %}
                <p>{{ para.text|safe }}</p>
            {%empty%}
                <p>No paragraph uploaded</p>
            {%endfor%}
        </div>
        <div class="type-para">
            <label for="typing-input">Type the Paragraph here</label>
            <textarea name="typing-input" id="typing-input" placeholder="Wait for the competition to start..." rows="1" oninput="checkInput(event)" disabled></textarea>
        </div>
        <div id="submission-section" style="display: none; margin-top: 1em; text-align: center;">
            <p>Competition has ended! Submit your final score.</p>
            <form id="result-form" method="post" action="{% url 'typing_game:submit_result' competition.id %}">
                {% csrf_token %}
                <input type="hidden" name="wpm" id="form-wpm">
                <input type="hidden" name="accuracy" id="form-accuracy">
                <input type="hidden" name="time_taken" id="form-time-taken">
                <button type="submit" class="button primary">Submit Result</button>
            </form>
        </div>
    </div>
{%endif%}
<div id="countdown-overlay">
    <div id="countdown-number"></div>
    <div id="countdown-message">The competition is about to begin...</div>
</div>
<div class="description_container">
    <h1>Description</h1>
    <div class="description">
        {{competition.description}}
    </div>
</div>
<script>
    function toggleExpand(containerClass) {
        const container = document.querySelector('.' + containerClass);
        const expandBtn = document.getElementById('expand-btn');
        const expandBtnIcon = expandBtn.querySelector('i');

        if (container.classList.contains('expanded')) {
            // Collapse the container
            expandBtn.style.position = '';
            container.classList.remove('expanded');
            container.style.position = '';
            container.style.top = '';
            container.style.left = '';
            container.style.transform = '';
            container.style.width = '';
            container.style.height = '';
            container.style.background = '';
            container.style.padding = '';
            expandBtnIcon.className = 'fas fa-expand';
        } else {
            // Expand the container
            expandBtn.style.position = 'fixed';
            container.classList.add('expanded');
            container.style.position = 'fixed';
            container.style.top = '50%';
            container.style.left = '50%';
            container.style.transform = 'translate(-50%, -50%)';
            container.style.width = '100vw';
            container.style.height = '100vh';
            container.style.padding = '3em 12em'
            container.style.background = 'var(--background-color)'; // Use theme background
            expandBtn.style.zIndex = '1001';
            expandBtnIcon.className = 'fas fa-compress';
        }
    }
    // --- Real-time Typing Calculation ---
    const typingInput = document.getElementById('typing-input');
    const textDisplay = document.getElementById('text-display');
    const wpmElement = document.getElementById('wpm');
    const accuracyElement = document.getElementById('accuracy');
    const timeElement = document.getElementById('time');
    const racerIcon = document.getElementById('racer-icon');

    // New elements for countdown and submission
    const countdownOverlay = document.getElementById('countdown-overlay');
    const countdownNumber = document.getElementById('countdown-number');

    let words = [];
    let currentWordIndex = 0;
    let correctWords = 0;
    let totalCharsTyped = 0;

    if (textDisplay) {
        // Wrap each word in a span to control it individually
        // Use innerText to preserve line breaks as '\n'
        const originalText = textDisplay.innerText.trim();
        // Split by space or newline, but keep the newlines in the array
        words = originalText.split(/(\s+)/).filter(w => w.length > 0);
        textDisplay.innerHTML = words.map(word => `<span>${word}</span>`).join(' ');
    }

    let startTime;
    let timerInterval;
    let competitionTimerInterval;

    // --- Competition State ---
    const competitionStarted = {{ competition.started|yesno:"true,false" }};
    const competitionStartTime = new Date("{{ competition.start_time.isoformat }}");
    const competitionDuration = {{ competition.duration }} * 60; // in seconds

    document.addEventListener('DOMContentLoaded', function() {
        if (competitionStarted) {
            const now = new Date();
            const countdownEndsAt = new Date(competitionStartTime.getTime());
            const secondsUntilStart = (countdownEndsAt - now) / 1000;

            if (secondsUntilStart > 0) {
                startPreCompetitionCountdown(secondsUntilStart);
            } else {
                // Competition already in progress
                const mainTimeLeft = competitionDuration + (secondsUntilStart);
                if (mainTimeLeft > 0) {
                    enableTyping();
                    startMainCompetitionTimer(mainTimeLeft);
                } else {
                    endCompetition();
                }
            }
        }
    });

    function startPreCompetitionCountdown(seconds) {
        countdownOverlay.style.display = 'flex';
        let count = Math.ceil(seconds);

        const countdownInterval = setInterval(() => {
            countdownNumber.textContent = count;
            if (count <= 0) {
                clearInterval(countdownInterval);
                countdownOverlay.style.display = 'none';
                enableTyping();
                startMainCompetitionTimer(competitionDuration);
            }
            count--;
        }, 1000);
    }

    function checkInput(event) {
        // This is the typing timer for WPM, not the main competition timer
        if (!startTime && typingInput.value.length > 0 && !typingInput.disabled) {
            startTime = new Date();
            timerInterval = setInterval(updateStats, 1000); // Update stats every second
        }

        const typedValue = typingInput.value;
        const currentWord = words[currentWordIndex];
        const wordSpans = textDisplay.querySelectorAll('span');

        // When space is pressed, it means the user is moving to the next word
        const isWordEnd = typedValue.endsWith(' ');
        const isNewline = event && event.key === 'Enter' && currentWord && currentWord.includes('\n');
        if (isWordEnd || isNewline) {
            const typedWord = typedValue.trim();

            // Don't do anything if the user just presses space
            if (typedWord === '') {
                typingInput.value = '';
                return;
            }

            if (isNewline) {
                totalCharsTyped += 1; // Count the enter key
            } else {
                totalCharsTyped += typedWord.length + 1; // +1 for the space
            }

            if (isNewline || typedWord === currentWord) {
                correctWords++;
                wordSpans[currentWordIndex].classList.add('correct-word');
            } else {
                wordSpans[currentWordIndex].classList.add('incorrect-word');
            }

            // Check if the paragraph is completed
            if (currentWordIndex + 1 === words.length) {
                // Reset to re-type
                currentWordIndex = -1; // Will be incremented to 0
                setTimeout(() => {
                    wordSpans.forEach(span => span.className = '');
                }, 200); // Small delay to let user see the last word's color
            }

            currentWordIndex++;
            typingInput.value = ''; // Clear the textarea for the next word

            // Remove the red background from the next word if it had one
            if (wordSpans[currentWordIndex]) {
                wordSpans[currentWordIndex].classList.remove('incorrect-word');
            }

        } else {
            // Check the current word being typed for correctness in real-time
            if (currentWord && currentWord.startsWith(typedValue)) {
                typingInput.classList.remove('incorrect-word');
            } else {
                typingInput.classList.add('incorrect-word');
            }
        }

        updateStats();
    }

    function startMainCompetitionTimer(durationInSeconds) {
        let timeLeft = durationInSeconds;
        competitionTimerInterval = setInterval(() => {
            if (timeLeft <= 0) {
                clearInterval(competitionTimerInterval);
                endCompetition();
            }
            const minutes = Math.floor(timeLeft / 60);
            const seconds = Math.floor(timeLeft % 60);
            timeElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')} / {{competition.duration}} minute(s)`;
            timeLeft--;
        }, 1000);
    }

    function enableTyping() {
        if (typingInput) {
            typingInput.disabled = false;
            typingInput.placeholder = "Start typing now!";
            typingInput.focus();
        }
    }

    function endCompetition() {
        if (typingInput) {
            typingInput.disabled = true;
            typingInput.placeholder = "Time's up!";
        }
        document.getElementById('submission-section').style.display = 'block';
    }

    function updateStats() {
        if (!startTime) return;

        // This is for WPM calculation, not the main timer display
        const elapsedTime = (new Date() - startTime) / 1000;

        // WPM is based on a standard of 5 characters per word (including space)
        const wpm = (totalCharsTyped / 5) / (elapsedTime / 60);
        wpmElement.textContent = elapsedTime > 0 ? Math.round(wpm) : 0;

        // Accuracy is based on correctly typed words vs total words attempted
        const accuracy = currentWordIndex > 0 ? (correctWords / currentWordIndex) * 100 : 100;
        accuracyElement.textContent = `${Math.round(accuracy)}%`;

        // Update racer position
        if (racerIcon && words.length > 0) {
            const progress = (currentWordIndex / words.length) * 100;
            racerIcon.style.left = `${Math.min(progress, 100)}%`;
        }

        // Update hidden form fields for submission
        document.getElementById('form-wpm').value = wpmElement.textContent;
        document.getElementById('form-accuracy').value = accuracyElement.textContent.replace('%', '');
        document.getElementById('form-time-taken').value = elapsedTime;
    }
</script>
{% endblock %}