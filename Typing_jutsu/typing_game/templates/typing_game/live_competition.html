<!-- live_competition.html -->
{% extends 'typing_game/base.html' %} 
{% load static %}

{% block title %}Live Competition: {{ competition.title }}{% endblock %}

{% block page %}
<style>
    .page-header{
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 1em 0;
    }
    .status-waiting { color: #ffc107; }
    .status-active { color: #28a745; }
    .status-ended { color: #dc3545; }

    .organizer-view, .participant-view {
        background: rgba(0,0,0,0.2);
        padding: 2em;
        border-radius: 8px;
    }

    .racetrack {
        position: relative;
        height: 200px;
        background: #333;
        border-radius: 5px;
        overflow: hidden;
        margin-bottom: 2em;
    }

    .typing-area {
        background: #222;
        padding: 1em;
        border-radius: 5px;
    }

    #text-display {
        font-size: 1.2em;
        line-height: 1.6;
        margin-bottom: 1em;
        color: #ddd;
    }

    #typing-input {
        width: 100%;
        padding: 0.5em;
        font-size: 1.1em;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 1em;
        margin-top: 1em;
        text-align: center;
    }

</style>
<div class="page-header">
    <h1>{{competition.title}} Live</h1>
    <div id="competition-status" class="status-{{ competition.status }}">
        Status: {{ competition.get_status_display }}
    </div>
    <div id="timer">--:--:--</div>
</div>

{# ================================= #}
{#      ORGANIZER-SPECIFIC VIEW      #}
{# ================================= #}
{% if user_role == 'organizer' %}
<div class="organizer-view">
    <h2>Organizer Dashboard</h2>
    <p>Monitor the competition in real-time.</p>

    <h3>Live Racetrack</h3>
    <div id="racetrack" class="racetrack">
        <!-- Racers will be dynamically added here by JavaScript -->
    </div>

    <h3>Live Leaderboard</h3>
    <table class="leaderboard-table">
        <thead>
            <tr>
                <th>Rank</th>
                <th>Participant</th>
                <th>WPM</th>
                <th>Accuracy</th>
            </tr>
        </thead>
        <tbody id="leaderboard-body">
            {% for result in results %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ result.participant.name }}</td>
                <td>{{ result.wpm|floatformat:0 }}</td>
                <td>{{ result.accuracy|floatformat:0 }}%</td>
            </tr>
            {% empty %}
            <tr><td colspan="4">No results yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{# =================================== #}
{#      PARTICIPANT-SPECIFIC VIEW      #}
{# =================================== #}
{% if user_role == 'participant' %}
<div class="participant-view">
    <h2>Get Ready to Type!</h2>

    <div class="typing-area">
        <div id="text-display">
            {% for para in competition.paragraphs %}
                <p>{{ para.text }}</p>
            {% endfor %}
        </div>
        <textarea id="typing-input" rows="5" placeholder="Start typing here when the competition begins..."></textarea>
    </div>

    <div class="stats-grid">
        <div><h3>WPM</h3><p id="wpm">0</p></div>
        <div><h3>Accuracy</h3><p id="accuracy">100%</p></div>
        <div><h3>Time</h3><p id="time">0s</p></div>
        <div><h3>Your Rank</h3><p id="rank">N/A</p></div>
    </div>
</div>
{% endif %}

<script>
    // Pass data from Django to JavaScript
    const competitionData = {
        id: "{{ competition.id }}",
        status: "{{ competition.status }}",
        startTime: "{{ competition.start_time.isoformat }}",
        endTime: "{{ competition.end_time.isoformat }}",
        timeRemaining: "{{ competition.end_time|date:'U' }}" - "{% now 'U' %}",
    };
    const userRole = "{{ user_role }}";
    const csrfToken = "{{ csrf_token }}";
</script>
<script src="{% static 'typing_game/js/live_competition.js' %}"></script>
{% endblock %}